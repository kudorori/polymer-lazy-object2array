<link rel="import" href="../polymer/polymer.html">

<!--
`lazy-object2array`


@demo demo/index.html 
-->

<dom-module id="lazy-object2array">
	<template>
		<template is="dom-if" if="[[dev]]">
			<button on-click="test">test</button>
			<button on-click="__testadd">add</button>
			<button on-click="__testchange">change</button>
			<button on-click="__testremove">remove</button>
			<button on-click="print">print</button>
			<template is="dom-repeat" items="{{array}}">
				<div>
					<input value="{{item.key::input}}" />
					<input value="{{item.value::input}}" />
				</div>
			</template>
			
			
		</template>
	</template>
  	<script>
	  	var hasSplice=new RegExp(/\.splice$/);
	  	var hasValue = new RegExp(/\.value$/);
	  	var hasKey = new RegExp(/\.key$/);
	    Polymer({
	      	is: 'lazy-object2array',
	      	print:function(){
		      	console.log(this.object,this.array);
	      	},
	      	test:function(){
		  		var a = ["a","b","c","d","e","f","g"];
		  		var result = {};
		  		a.forEach(function(i1){
			  		a.forEach(function(i2){
				  		result[i1+i2]=0;
			  		})
		  		});
		  		this.set("object",result);
	      	},
	      	__testchange:function(){
		      	this.set("object.c",123123123);
	      	},
	      	__testadd:function(){
		      	this.push("array",{
			      	key:"c",
			      	value:"123"
		      	});
		      	console.log(this.array,this.object);
	      	},
	      	__testremove:function(){
		      	this.splice("array",0,1);
	      	},
	      	properties: {
		      	dev:{
			      	type:Boolean,
			      	value:false
		      	},
		        array:{
			        type:Array,
			        notify:true
		        },
		        object:{
			        type:Object,
			        notify:true
		        }
	      	},
	      	observers:[
		      	"_objectChanged(object.*)",
		      	"_arrayChanged(array.*)"
	      	],
	      	_arrayChanged:function(change){
		      	if(this._setting){
			      	return;
		      	}
		      	this._setting=true;
		      	var that = this;
		      	if(change.path=="array"){
			      	this._rewriteObject(change.base).then(function(result){
				      	delete that._setting;
				      	that.set("object",result);
			      	}.bind(this));
		      	}else if(hasSplice.test(change.path)){
			      	this._rewriteObject(change.base).then(function(result){
				      	delete that._setting;
				      	that.set("object",result);
			      	}.bind(this));
		      	}else if(hasValue.test(change.path)){
			      	this._rewriteObject(change.base).then(function(result){
				      	delete that._setting;
				      	that.set("object",result);
			      	}.bind(this));
		      	}else if(hasKey.test(change.path)){
			      	console.log("key");
			      	this._rewriteObject(change.base).then(function(result){
				      	delete that._setting;
				      	that.set("object",result);
			      	}.bind(this));
		      	}
	      	},
	      	_rewriteObject:function(items){
		      	return new Promise(function(resolve,reject){
			      	var result = {};
			      	items.forEach(function(item){
				      	result[item.key]=item.value;
			      	});
			      	resolve(result);
		      	})
	      	},
	      	_objectChanged:function(change){
		      	console.log(change,this._setting);
		      	if(this._setting){
			      	return;
		      	}
		      	this._setting=true;
		      	var that = this;
		      	if(change.path=="object"){
			      	this._rewriteArray(change.base).then(function(result){
				    	that.set("array",result);
				    	delete that._setting;
			      	});
		      	}else{ 
			      	this._rewriteElement(change.path).then(function(arrayKey){
				      	that.set("array.#"+arrayKey,change.value);
			      	}).catch(function(objectKey){
				      	console.log(objectKey,change.value);
				      	that.push("array",{
					      	key:objectKey,
					      	value:change.value
				      	});
			      	}).then(function(){
				      	delete that._setting;
			      	})
		      	}
	      	},
	      	_rewriteArray:function(obj){
		      	return new Promise(function(resolve,reject){
			      	var result = Object.keys(obj).map(function(key){
				      	return {key:key,value:obj[key]}
			      	});
			      	resolve(result);
		      	});
	      	},
	      	_rewriteElement:function(change){
		      	return new Promise(function(resolve,reject){
			      	console.log("rewriteElement");
			      	var path = change.split(".");
			      	var key = path[1];
			      	var check = this.array.filter(function(item){
				      	return item.key==key;
			      	});
			      	if(check.length>0){
				      	resolve(check[0].key);
			      	}else{
				      	reject(key);
			      	}
		      	}.bind(this))
	      	}
	    });
  	</script>
</dom-module>
